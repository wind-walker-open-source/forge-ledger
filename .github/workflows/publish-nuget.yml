name: Publish NuGet Packages

on:
  release:
    types: [published]

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  NuGetDirectory: ${{ github.workspace }}/nuget

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for SourceLink

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Pack ForgeLedger.Contracts
        run: |
          dotnet pack ForgeLedger.Contracts/ForgeLedger.Contracts.csproj \
            --no-build \
            --configuration Release \
            --output ${{ env.NuGetDirectory }} \
            -p:PackageVersion=${{ steps.version.outputs.VERSION }}

      - name: Pack ForgeLedger.Client
        run: |
          dotnet pack ForgeLedger.Client/ForgeLedger.Client.csproj \
            --no-build \
            --configuration Release \
            --output ${{ env.NuGetDirectory }} \
            -p:PackageVersion=${{ steps.version.outputs.VERSION }}

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          if-no-files-found: error
          retention-days: 7
          path: ${{ env.NuGetDirectory }}/*.nupkg

      - name: Upload symbol packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-symbols
          if-no-files-found: warn
          retention-days: 7
          path: ${{ env.NuGetDirectory }}/*.snupkg

  publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ${{ env.NuGetDirectory }}

      - name: Download symbol packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-symbols
          path: ${{ env.NuGetDirectory }}
        continue-on-error: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish to NuGet.org
        run: |
          for package in ${{ env.NuGetDirectory }}/*.nupkg; do
            dotnet nuget push "$package" \
              --api-key ${{ secrets.NUGET_API_KEY }} \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

      - name: Publish symbols to NuGet.org
        run: |
          for package in ${{ env.NuGetDirectory }}/*.snupkg; do
            if [ -f "$package" ]; then
              dotnet nuget push "$package" \
                --api-key ${{ secrets.NUGET_API_KEY }} \
                --source https://api.nuget.org/v3/index.json \
                --skip-duplicate
            fi
          done
        continue-on-error: true
